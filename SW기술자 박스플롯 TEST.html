<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>외주용역 박스플롯 · 대분류 드롭다운 / 서비스등급 X축</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    :root {
      --bg: #0f172a; --panel: #111827; --ink: #e5e7eb; --muted: #9ca3af;
      --brand: #60a5fa; --border: #1f2937;
    }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--ink);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,"Apple SD Gothic Neo","Malgun Gothic",sans-serif;
    }
    header { padding:18px 24px; border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,#0f172a 0%, #0b1222 100%);
    }
    h1 { font-size:18px; margin:0 0 6px; }
    .wrap { display:grid; grid-template-columns:360px 1fr; gap:16px; padding:18px 24px; }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; }
    label { display:block; margin:8px 0 6px; color:var(--muted); font-size:13px; }
    select, input[type="file"], button {
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid #374151;
      background:#0b1222; color:var(--ink);
    }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    #plot { height:72vh; }
    .hint { color:var(--muted); font-size:12px; margin-top:6px; line-height:1.4; }
    .badge { display:inline-block; padding:2px 8px; border-radius:9999px; font-size:11px;
      background:#0b2546; color:#b9dcff; border:1px solid #1f3b66;
    }
    .file-row { display:flex; gap:10px; align-items:center; }
    .file-name { flex:1; min-height:40px; display:flex; align-items:center; padding:0 12px;
      border:1px solid #374151; border-radius:12px; background:#0b1222; color:#9ca3af; font-size:13px;
    }
    .btn { cursor:pointer; }
    /* 박스플롯 설명 */
    #explanation {
      margin: 20px 24px 40px; padding:16px; border:1px solid var(--border);
      border-radius:12px; background:#111827; color:var(--muted); font-size:13px; line-height:1.6;
    }
    #explanation b { color:var(--brand); }
  </style>
</head>
<body>
  <header>
    <h1>외주용역 박스플롯</h1>
    <div class="hint">
      조건(드롭다운): <span class="badge">대분류=P열(분류)</span> · X축: <span class="badge">서비스등급=U열</span> · Y축:
      <span class="badge">서비스단가=Z열(고정)</span> · 데이터 행: <span class="badge">477–750행</span>
    </div>
  </header>

  <div class="wrap">
    <section class="card">
      <label>데이터 불러오기</label>
      <div class="file-row" style="margin-bottom:10px;">
        <button id="loadDefault" class="btn">기본 파일(data.xlsx) 읽기</button>
        <label class="btn" style="display:block; text-align:center; line-height:20px; padding:10px 12px;">
          <input type="file" id="file" accept=".xlsx,.xls" style="display:none;" />
          엑셀 파일 업로드
        </label>
      </div>
      <div class="file-row" style="margin-top:10px;">
        <div class="file-name" id="fileName">선택된 파일이 없습니다.</div>
      </div>

      <label style="margin-top:14px;">대분류(분류 · P열) 선택</label>
      <select id="category"></select>

      <label style="margin-top:14px;">옵션</label>
      <div class="row">
        <select id="orientation">
          <option value="v" selected>수직 박스(서비스등급 = X축)</option>
          <option value="h">수평 박스(서비스등급 = Y축)</option>
        </select>
        <select id="outliers">
          <option value="suspected" selected>이상치 표시</option>
          <option value="none">이상치 숨김</option>
        </select>
      </div>

      <div class="hint" style="margin-top:10px;">
        ※ 헤더가 없어도 동작하지만, 헤더가 있으면 숫자 컬럼 탐지가 더 정확합니다.<br/>
        ※ 범위: 477–750행만 사용합니다.
      </div>
    </section>

    <section class="card">
      <div id="plot"></div>
    </section>
  </div>

  <!-- 박스플롯 설명 추가 -->
  <div id="explanation">
    <b>박스플롯(Box Plot)</b>은 데이터 분포의 특성을 한눈에 보여주는 통계적 도표입니다.<br>
    - <b>박스</b>: 전체 데이터 중 가운데 50%(1사분위수~3사분위수)를 의미합니다.<br>
    - <b>가운데 선</b>: 중앙값(Median)을 나타냅니다.<br>
    - <b>수염(Whisker)</b>: 이상치를 제외한 최소~최대값 범위를 나타냅니다.<br>
    - <b>점(●)</b>: 이상치(Outlier)를 표시합니다.<br>
    이 그래프는 서비스등급(U열)별 서비스단가(Z열)의 분포와 이상치를 시각적으로 비교할 수 있게 합니다.
  </div>

  <script>
    // --- 고정 X축 순서 ---
    const GRADE_ORDER = ['초급','중급','고급','특급','컨설턴트'];
    const EXCEL_SHEET_NAME = "외주용역";
    const ROW_START = 477, ROW_END = 750;
    const COL_P_IDX = 15, COL_U_IDX = 20, COL_Z_IDX = 25;

    const els = {
      file: document.getElementById('file'),
      fileName: document.getElementById('fileName'),
      loadDefault: document.getElementById('loadDefault'),
      category: document.getElementById('category'),
      orientation: document.getElementById('orientation'),
      outliers: document.getElementById('outliers'),
      plot: document.getElementById('plot'),
    };

    let state = { headers: [], rows: [], categoryValues: [] };

    function unique(arr){ return Array.from(new Set(arr.filter(v => v && String(v).trim() !== ''))); }

    async function loadWorkbookFromArrayBuffer(ab){
      const wb = XLSX.read(ab, { type: 'array' });
      const sheetName = wb.Sheets[EXCEL_SHEET_NAME] ? EXCEL_SHEET_NAME : wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];
      return XLSX.utils.sheet_to_json(ws, { header:1, raw:true, defval:null });
    }

    document.querySelector('label.btn input[type="file"]').addEventListener('change', async e=>{
      const f = e.target.files?.[0];
      els.fileName.textContent = f ? f.name : '선택된 파일이 없습니다.';
      if (!f) return;
      const ab = await f.arrayBuffer();
      const rows = await loadWorkbookFromArrayBuffer(ab);
      ingestRows(rows);
    });

    els.loadDefault.addEventListener('click', async ()=>{
      try {
        const res = await fetch('data.xlsx');
        if (!res.ok) throw new Error('data.xlsx를 찾을 수 없습니다.');
        const ab = await res.arrayBuffer();
        const rows = await loadWorkbookFromArrayBuffer(ab);
        els.fileName.textContent = 'data.xlsx (기본 파일)';
        ingestRows(rows);
      } catch(err){ alert(err.message); }
    });

    function ingestRows(rows){
      if (!rows || !rows.length){ alert('시트가 비어있습니다.'); return; }
      const first = rows[0] || [];
      const headerLike = first.some(v => typeof v === 'string');
      let headerRow = headerLike ? first : [];
      let data = headerLike ? rows.slice(1) : rows;
      const startIdx = ROW_START - 1 - (headerLike ? 1 : 0);
      const endIdx = ROW_END - 1 - (headerLike ? 1 : 0);
      const slice = data.filter((_, i)=> i>=startIdx && i<=endIdx);
      state.rows = slice;
      state.headers = headerRow;
      const pVals = slice.map(r=>r[COL_P_IDX]).filter(v=>v);
      state.categoryValues = unique(pVals).sort((a,b)=>String(a).localeCompare(String(b),'ko',{numeric:true}));
      populateCategorySelect();
      els.orientation.onchange = draw;
      els.outliers.onchange = draw;
      draw();
    }

    function populateCategorySelect(){
      els.category.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value='__ALL__'; optAll.textContent=`전체 (${state.categoryValues.length}개 분류)`;
      els.category.appendChild(optAll);
      state.categoryValues.forEach(v=>{
        const o=document.createElement('option');
        o.value=v; o.textContent=v;
        els.category.appendChild(o);
      });
      els.category.value='__ALL__';
      els.category.onchange=draw;
    }

    function draw(){
      if(!state.rows.length){ Plotly.purge(els.plot); return; }
      const catSel=els.category.value, orient=els.orientation.value, showOutliers=els.outliers.value!=='none';
      const filtered=state.rows.filter(r=>{
        const p=r[COL_P_IDX],u=r[COL_U_IDX],y=r[COL_Z_IDX];
        if(!p||!u||!isFinite(+y)) return false;
        return catSel==='__ALL__'||String(p)===catSel;
      });
      const byGrade=new Map();
      for(const r of filtered){
        const g=String(r[COL_U_IDX]).trim(); const v=+r[COL_Z_IDX];
        if(!byGrade.has(g)) byGrade.set(g,[]);
        byGrade.get(g).push(v);
      }
      const traces=[], metricName=state.headers[COL_Z_IDX]??'서비스단가';
      for(const g of GRADE_ORDER){
        const arr=(byGrade.get(g)||[]).filter(Number.isFinite);
        if(arr.length>0){
          const hover=(orient==='v')?`${g}<br>%{y:,.0f}원<extra></extra>`:`${g}<br>%{x:,.0f}원<extra></extra>`;
          const t={type:'box',name:g,boxpoints:showOutliers?'suspectedoutliers':false,jitter:0.3,pointpos:0,hovertemplate:hover};
          if(orient==='v') t.y=arr; else {t.x=arr;t.orientation='h';}
          traces.push(t);
        } else {
          const ph={type:'box',name:g,boxpoints:false,hoverinfo:'skip',line:{color:'rgba(0,0,0,0)'},fillcolor:'rgba(0,0,0,0)',marker:{color:'rgba(0,0,0,0)'}};
          if(orient==='v') ph.y=[0]; else {ph.x=[0];ph.orientation='h';}
          traces.push(ph);
        }
      }
      const layout={
        paper_bgcolor:'#0f172a',plot_bgcolor:'#0f172a',font:{color:'#e5e7eb'},
        margin:{t:48,r:24,b:72,l:84},title:`${catSel==='__ALL__'?'전체 분류':`분류: ${catSel}`} · Y축: ${metricName}`,
        showlegend:false
      };
      if(orient==='v'){ layout.xaxis={title:'서비스등급',categoryarray:GRADE_ORDER,tickvals:GRADE_ORDER,gridcolor:'#1f2937'}; layout.yaxis={tickformat:',',ticksuffix:'원',gridcolor:'#1f2937'}; }
      else { layout.yaxis={title:'서비스등급',categoryarray:GRADE_ORDER,tickvals:GRADE_ORDER,gridcolor:'#1f2937'}; layout.xaxis={tickformat:',',ticksuffix:'원',gridcolor:'#1f2937'}; }
      Plotly.react(els.plot,traces,layout,{responsive:true,displaylogo:false});
    }

    (async function tryAutoLoad(){
      try{
        const res=await fetch('data.xlsx',{method:'HEAD'});
        if(res.ok){ const get=await fetch('data.xlsx'); const ab=await get.arrayBuffer();
          const rows=await loadWorkbookFromArrayBuffer(ab);
          els.fileName.textContent='data.xlsx (자동 로드)'; ingestRows(rows);
        }
      }catch(e){}
    })();
  </script>
</body>
</html>
