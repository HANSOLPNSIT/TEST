<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SW기술자 박스플롯 TEST · 기본값: 이상치 숨김</title>
  <!-- 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af; --brand:#60a5fa; --border:#1f2937;
      --good: rgba(16,185,129,.18); --warn: rgba(234,179,8,.18); --bad: rgba(248,113,113,.18);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Apple SD Gothic Neo","Noto Sans KR",sans-serif}
    header{position:sticky;top:0;z-index:10;background:var(--bg);border-bottom:1px solid var(--border);
      padding:14px 16px}
    h1{margin:0;font-size:18px;font-weight:600}
    .sub{color:var(--muted);font-size:12px;margin-top:6px}
    .bar{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    select, input[type="checkbox"]{accent-color:var(--brand)}
    select{background:#0b1220;color:var(--ink);border:1px solid var(--border);border-radius:8px;padding:8px 10px}
    button{background:var(--brand);border:0;color:#002244;border-radius:10px;padding:9px 14px;font-weight:600;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    main{padding:14px 16px}
    #chart{width:100%;height:560px;border:1px solid var(--border);border-radius:12px;background:linear-gradient(0deg,#0b1220,#0b1220) padding-box,linear-gradient(135deg,transparent,rgba(96,165,250,.15)) border-box}
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
    .kv{display:flex;gap:8px;align-items:center}
    .hint{color:var(--muted);font-size:12px;margin-top:8px}
    .legend{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.6}
    .sp{height:10px}
  </style>
</head>
<body>
  <header>
    <h1>SW기술자 박스플롯 TEST <span class="sub">· 기본값: 이상치 숨김</span></h1>
    <div class="bar">
      <div class="panel row">
        <div class="kv">
          <label for="remoteUrl">데이터 URL</label>
          <input id="remoteUrl" type="text" style="min-width:340px;background:#0b1220;color:var(--ink);border:1px solid var(--border);border-radius:8px;padding:8px 10px"
            placeholder="예) /data.xlsx 또는 https://.../data.xlsx">
        </div>
        <div class="kv">
          <label for="file">또는 파일</label>
          <input id="file" type="file" accept=".xlsx,.xls" />
        </div>
        <button id="loadBtn">데이터 불러오기</button>
      </div>

      <div class="panel row">
        <div class="kv">
          <label for="catSel">대분류(분류)</label>
          <select id="catSel" disabled></select>
        </div>
        <div class="kv">
          <label for="outlierChk">이상치 표시</label>
          <!-- 기본: 체크 해제(숨김) -->
          <input id="outlierChk" type="checkbox" />
        </div>
        <button id="drawBtn" disabled>차트 다시 그리기</button>
      </div>
    </div>
    <div class="hint">• 시트명: <b>외주용역</b> · 열 매핑: <b>P=분류</b>, <b>U=서비스등급</b>, <b>Z=서비스단가</b> · 값은 숫자만 사용</div>
  </header>

  <main>
    <div id="chart"></div>
    <div class="legend">
      ▪ 박스 = IQR(Q1~Q3), 중앙선 = Q2(중앙값), 수염 = Tukey 방식(기본) ·
      이상치(outliers)는 기본적으로 숨김.<br/>
      ▪ “이상치 표시”를 켜면 IQR·1.5 범위를 벗어나는 점들이 나타납니다.
    </div>
  </main>

  <script>
    // ----- 유틸: 숫자만 추출 -----
    const toNumber = (v) => {
      if (v == null) return NaN;
      if (typeof v === 'number') return v;
      // "10,000,000원" 같은 포맷 지원
      const s = String(v).replace(/[^\d.-]/g, '');
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : NaN;
    };

    // ----- 상태 -----
    let allRows = [];   // {분류, 서비스등급, 서비스단가}
    let byCategory = new Map(); // key: 분류, value: rows

    // ----- DOM -----
    const $remote = document.getElementById('remoteUrl');
    const $file = document.getElementById('file');
    const $load = document.getElementById('loadBtn');
    const $cat = document.getElementById('catSel');
    const $out = document.getElementById('outlierChk');
    const $draw = document.getElementById('drawBtn');

    // 첫 화면 기본 URL 추정(동일 리포지토리 루트에 data.xlsx가 있을 때)
    $remote.value = '/purchasing5919/data.xlsx';

    // ----- XLSX 로드 -----
    async function loadFromUrl(url){
      const res = await fetch(url);
      if (!res.ok) throw new Error('데이터 URL 응답 오류: ' + res.status);
      const buf = await res.arrayBuffer();
      return XLSX.read(buf, {type:'array'});
    }
    async function loadFromFile(file){
      const buf = await file.arrayBuffer();
      return XLSX.read(buf, {type:'array'});
    }

    function extractRows(wb){
      const ws = wb.Sheets['외주용역'];
      if(!ws) throw new Error('시트 "외주용역"을 찾을 수 없습니다.');
      const aoa = XLSX.utils.sheet_to_json(ws, {header:1, defval:null});
      if(aoa.length === 0) throw new Error('빈 시트입니다.');
      // 헤더 행 찾기: "분류","서비스등급","서비스단가" 컬럼 헤더 텍스트 기반
      const header = aoa[0].map(v => v ? String(v).trim() : '');
      const idxP = header.findIndex(h => h.includes('분류'));
      const idxU = header.findIndex(h => h.replace(/\s/g,'').includes('서비스등급'));
      const idxZ = header.findIndex(h => h.includes('서비스단가'));
      if (idxP < 0 || idxU < 0 || idxZ < 0) {
        // 백업: 고정 열(P,U,Z) 시도로 추출 (엑셀 열 → 0 기반 인덱스)
        // P=15-1=15?  A=0 → P=15, U=20, Z=25
        console.warn('헤더 기반 매핑 실패, 고정열(P,U,Z)로 시도합니다.');
      }
      const P = idxP >= 0 ? idxP : 15;
      const U = idxU >= 0 ? idxU : 20;
      const Z = idxZ >= 0 ? idxZ : 25;

      const rows = [];
      for (let r = 1; r < aoa.length; r++){
        const row = aoa[r];
        if(!row || row.length === 0) continue;
        const 분류 = row[P];
        const 등급 = row[U];
        const 단가 = toNumber(row[Z]);
        if (분류 == null || 등급 == null) continue;
        if (!Number.isFinite(단가)) continue;
        rows.push({ 분류: String(분류).trim(), 서비스등급: String(등급).trim(), 서비스단가: 단가 });
      }
      return rows;
    }

    function buildCategoryIndex(rows){
      const map = new Map();
      for (const r of rows){
        if (!map.has(r.분류)) map.set(r.분류, []);
        map.get(r.분류).push(r);
      }
      return map;
    }

    function fillCategorySelect(map){
      const cats = Array.from(map.keys()).sort((a,b)=>a.localeCompare(b,'ko'));
      $cat.innerHTML = '';
      for (const c of cats){
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        $cat.appendChild(opt);
      }
      $cat.disabled = cats.length === 0;
      $draw.disabled = cats.length === 0;
    }

    function groupByGrade(rows){
      const g = new Map();
      for (const r of rows){
        if (!g.has(r.서비스등급)) g.set(r.서비스등급, []);
        g.get(r.서비스등급).push(r.서비스단가);
      }
      // 등급명 정렬(자연, 숫자 혼합 고려 X — 필요시 커스텀 정렬)
      return Array.from(g.entries()).sort((a,b)=>a[0].localeCompare(b[0],'ko'));
    }

    function won(v){ // 호버표시용
      return (Math.round(v)).toLocaleString('ko-KR') + '원';
    }

    function drawPlot(category, showOutliers){
      const rows = byCategory.get(category) || [];
      const groups = groupByGrade(rows);

      const traces = groups.map(([grade, values]) => ({
        type: 'box',
        y: values,
        name: grade,
        boxpoints: showOutliers ? 'outliers' : false, // ★ 기본값: false
        jitter: 0, // 점 산포 사용 안 함
        pointpos: 0,
        marker: { size: 6 },
        hovertemplate: `<b>${grade}</b><br>` +
                       `서비스단가: %{y:,.0f}원<extra></extra>`
      }));

      const layout = {
        paper_bgcolor: '#0b1220',
        plot_bgcolor: '#0b1220',
        margin: {l:70,r:20,t:36,b:60},
        title: {text: `대분류: ${category} · 서비스등급별 박스플롯`, font:{color:'#e5e7eb', size:16}},
        font: {color:'#e5e7eb'},
        xaxis: {
          title: '서비스등급',
          tickfont:{size:12},
          gridcolor:'#182235',
          linecolor:'#334155',
          zerolinecolor:'#182235'
        },
        yaxis: {
          title: '서비스단가 (원)',
          tickformat: ',.0f',
          gridcolor:'#182235',
          linecolor:'#334155',
          zerolinecolor:'#182235'
        },
        boxmode: 'group',
        showlegend: false
      };

      Plotly.react('chart', traces, layout, {displaylogo:false, responsive:true});
    }

    // ----- 이벤트 -----
    $load.addEventListener('click', async ()=>{
      try{
        $load.disabled = true;
        $draw.disabled = true;
        $cat.disabled = true;

        let wb;
        if ($file.files && $file.files[0]){
          wb = await loadFromFile($file.files[0]);
        } else if ($remote.value.trim()){
          wb = await loadFromUrl($remote.value.trim());
        } else {
          alert('데이터 URL을 입력하거나 파일을 선택하세요.');
          return;
        }

        allRows = extractRows(wb);
        if (allRows.length === 0){
          alert('유효한 데이터 행을 찾지 못했습니다(숫자 단가가 필요).');
          return;
        }
        byCategory = buildCategoryIndex(allRows);
        fillCategorySelect(byCategory);

        // 기본 첫 카테고리로 그리기 + 이상치 숨김(기본 체크 해제)
        const firstCat = $cat.options[0]?.value;
        if (firstCat){
          $out.checked = false; // 기본값: 숨김
          drawPlot(firstCat, /*showOutliers*/ false);
        }
      } catch(err){
        console.error(err);
        alert('로딩 오류: ' + err.message);
      } finally{
        $load.disabled = false;
        $draw.disabled = $cat.disabled;
      }
    });

    $cat.addEventListener('change', ()=>{
      if ($cat.value){
        drawPlot($cat.value, $out.checked);
      }
    });

    $out.addEventListener('change', ()=>{
      if ($cat.value){
        drawPlot($cat.value, $out.checked);
      }
    });

    $draw.addEventListener('click', ()=>{
      if ($cat.value){
        drawPlot($cat.value, $out.checked);
      }
    });

    // 페이지 진입 시 자동 로드 시도 (리포지토리에 data.xlsx가 있을 때 편의)
    window.addEventListener('DOMContentLoaded', ()=>{
      // 자동 로드는 원치 않으면 이 줄을 주석 처리
      // $load.click();
    });
  </script>
</body>
</html>
