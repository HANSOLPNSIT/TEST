<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>구매 이력 조회 · 업체/대분류 드롭다운 + 전체 검색</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --bg: #0f172a;        /* slate-900 */
      --panel: #111827;     /* gray-900 */
      --ink: #e5e7eb;       /* gray-200 */
      --muted: #9ca3af;     /* gray-400 */
      --brand: #60a5fa;     /* blue-400 */
      --border: #1f2937;    /* gray-800 */
      --accent: #22c55e;    /* green-500 */
    }
    * { box-sizing: border-box; }
    body { background: var(--bg); color: var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif; margin: 0; }
    header { padding: 18px 20px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: linear-gradient(180deg, rgba(15,23,42,.98), rgba(15,23,42,.92)); backdrop-filter: blur(6px); z-index: 10; }
    h1 { margin: 0 0 10px; font-size: 20px; font-weight: 700; letter-spacing: .2px; }
    .controls { display: grid; gap: 10px; grid-template-columns: 1fr 1fr 1.2fr auto; align-items: center; }
    .controls label { font-size: 12px; color: var(--muted); }
    .control { display: grid; gap: 6px; }
    input[type="text"], input[type="search"], select, button, input[type="file"] {
      background: #0b1220; border: 1px solid var(--border); color: var(--ink);
      padding: 10px 12px; border-radius: 12px; outline: none; font-size: 14px;
    }
    input[type="file"] { padding: 8px 10px; }
    button { cursor: pointer; transition: .2s ease; }
    button.primary { background: var(--brand); border-color: transparent; color: #0b1220; font-weight: 700; }
    button.ghost { background: transparent; border-color: var(--border); }

    main { padding: 16px 20px 80px; }
    .summary { font-size: 13px; color: var(--muted); margin: 10px 0 16px; }

    table { width: 100%; border-collapse: collapse; background: #0b1220; border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
    thead th { position: sticky; top: 74px; background: #0d1526; color: var(--muted); font-weight: 600; font-size: 12px; letter-spacing: .2px; border-bottom: 1px solid var(--border); padding: 10px 8px; text-align: left; }
    tbody td { padding: 10px 8px; border-bottom: 1px solid var(--border); font-size: 14px; }
    tbody tr:hover { background: rgba(96,165,250,0.08); }
    .right { text-align: right; }
    .pill { display:inline-block; padding: 3px 8px; border-radius: 999px; border:1px solid var(--border); font-size: 12px; color: var(--ink); background:#0f1a2f; }

    .chips { display:flex; gap:8px; flex-wrap:wrap; margin: 12px 0 4px; }
    .chip { border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; color:var(--muted); }

    .hidden { display: none !important; }
    .count { font-variant-numeric: tabular-nums; }

    .footer { position: fixed; bottom: 12px; right: 12px; display: flex; gap: 8px; }
  </style>
</head>
<body>
  <header>
    <h1>구매 이력 조회 · 업체/대분류 필터 + 전체 검색</h1>
    <div class="controls">
      <div class="control">
        <label>데이터 파일 (Excel .xlsx) — 기본: <code>data.xlsx</code></label>
        <input id="file" type="file" accept=".xlsx,.xls" />
      </div>
      <div class="control">
        <label>구매처명 (검색 가능 드롭다운)</label>
        <!-- datalist 로 검색 가능한 드롭다운 구현 -->
        <input id="vendorInput" list="vendorList" placeholder="모든 구매처" />
        <datalist id="vendorList"></datalist>
      </div>
      <div class="control">
        <label>대분류 (검색 가능 드롭다운)</label>
        <input id="catInput" list="catList" placeholder="모든 대분류" />
        <datalist id="catList"></datalist>
      </div>
      <div class="control">
        <label>전체 데이터 검색</label>
        <input id="globalSearch" type="search" placeholder="프로젝트명, 분류, 비고 등 키워드" />
      </div>
    </div>
    <div class="chips" id="activeFilters" aria-live="polite"></div>
    <div class="summary"><span class="count" id="countShown">0</span>건 / 총 <span class="count" id="countTotal">0</span>건 · 정렬: <button class="ghost" id="sortBtn" title="PO생성일 정렬 전환">PO생성일 ⬇</button></div>
  </header>

  <main>
    <table id="table" aria-describedby="countShown countTotal">
      <thead>
        <tr>
          <th>PO생성일</th>
          <th>프로젝트명</th>
          <th>분류</th>
          <th class="right">서비스단가</th>
          <th>서비스단위</th>
          <th>서비스등급내역</th>
          <th class="right">서비스수량</th>
          <th>비고</th>
          <th class="hidden">구매처명</th>
          <th class="hidden">대분류</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </main>

  <div class="footer">
    <button id="resetBtn" class="ghost">필터 초기화</button>
    <button id="reloadBtn" class="primary">기본파일 다시 불러오기</button>
  </div>

  <script>
    // ====== 설정: 시트 및 컬럼 헤더 명칭 표준화 ======
    const PREFERRED_SHEET_NAMES = ["외주용역", "Sheet1", "data", "DATA"]; // 우선 탐색 순서
    // 입력 엑셀의 열 헤더를 다음 키로 매핑 (대/소문자·공백 무시 매칭)
    const HEADER_MAP = {
      vendor: ["구매처명", "업체", "벤더", "Vendor", "매입처"],
      category: ["대분류", "분류(대)", "Category", "카테고리"],
      poDate: ["PO생성일", "발주생성일", "주문일", "PO Date", "PO일자"],
      project: ["프로젝트명", "사업명", "프로젝트", "Project"],
      type: ["분류", "소분류", "Type"],
      unitPrice: ["서비스단가", "단가", "UnitPrice", "금액"],
      unit: ["서비스단위", "단위", "Unit"],
      grade: ["서비스등급내역", "등급", "Grade"],
      qty: ["서비스수량", "수량", "Qty", "수량(EA)"],
      note: ["비고", "메모", "Remark", "Note"]
    };

    let rawRows = [];     // 원본 전체 행
    let viewRows = [];    // 필터/검색/정렬 후 표시 행
    let sortAsc = false;  // 기본: PO생성일 내림차순(최근 우선)

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    const tbody = $("#tbody");
    const vendorInput = $("#vendorInput");
    const catInput = $("#catInput");
    const vendorList = $("#vendorList");
    const catList = $("#catList");
    const globalSearch = $("#globalSearch");

    const countShown = $("#countShown");
    const countTotal = $("#countTotal");

    const sortBtn = $("#sortBtn");

    const resetBtn = $("#resetBtn");
    const reloadBtn = $("#reloadBtn");

    // 숫자/통화/날짜 유틸
    const fmtKRW = (n) => (n === null || n === undefined || n === "") ? "" :
      new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(Number(n)) + "원";
    const fmtQty = (n) => (n === null || n === undefined || n === "") ? "" : new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 2 }).format(Number(n));
    const parseDate = (v) => {
      if (!v && v !== 0) return null;
      // Excel serial date 또는 문자열 처리
      if (typeof v === 'number') {
        const date = XLSX.SSF.parse_date_code(v);
        return new Date(date.y, date.m - 1, date.d);
      }
      const s = String(v).trim().replaceAll(".", "-").replaceAll("/", "-");
      const tryDate = new Date(s);
      return isNaN(tryDate) ? null : tryDate;
    };
    const fmtDate = (d) => !d ? "" : d.toISOString().slice(0,10);

    const norm = (s) => (s ?? "").toString().trim();

    function detectHeaders(headerRow) {
      const hmap = {};
      const normHeaderRow = headerRow.map(h => norm(h).toLowerCase());
      for (const [key, aliases] of Object.entries(HEADER_MAP)) {
        let idx = -1;
        for (const alias of aliases) {
          const i = normHeaderRow.indexOf(norm(alias).toLowerCase());
          if (i !== -1) { idx = i; break; }
        }
        hmap[key] = idx; // -1 이면 누락
      }
      return hmap;
    }

    function loadSheet(workbook) {
      // 시트 선택
      let sheetName = workbook.SheetNames.find(n => PREFERRED_SHEET_NAMES.includes(n)) || workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
      if (!rows.length) throw new Error("시트가 비어 있습니다.");

      const header = rows[0];
      const map = detectHeaders(header);

      // 필수 컬럼 확인 (vendor, category, poDate 중 최소 vendor/poDate는 있어야 함)
      const required = ["vendor", "poDate", "project", "unitPrice"]; // 핵심 필드
      const missing = required.filter(k => map[k] === -1);
      if (missing.length) {
        console.warn("누락된 헤더:", missing);
      }

      rawRows = rows.slice(1).map(r => ({
        vendor: norm(r[map.vendor]),
        category: norm(r[map.category]),
        poDate: parseDate(r[map.poDate]),
        project: norm(r[map.project]),
        type: norm(r[map.type]),
        unitPrice: r[map.unitPrice] === "" ? "" : Number(String(r[map.unitPrice]).replace(/[^\d.-]/g, "")),
        unit: norm(r[map.unit]),
        grade: norm(r[map.grade]),
        qty: r[map.qty] === "" ? "" : Number(String(r[map.qty]).replace(/[^\d.-]/g, "")),
        note: norm(r[map.note])
      })).filter(r => Object.values(r).some(v => v !== ""));

      // 초기 정렬: PO생성일 최근 ↓
      sortAsc = false;
      sortRows();

      // 필터용 옵션 만들기
      populateOptions();

      // 렌더
      applyFiltersAndRender();

      countTotal.textContent = rawRows.length.toLocaleString('ko-KR');
    }

    function sortRows() {
      viewRows.sort((a,b) => {
        const ad = a.poDate?.getTime() ?? -Infinity;
        const bd = b.poDate?.getTime() ?? -Infinity;
        return sortAsc ? ad - bd : bd - ad;
      });
    }

    function populateOptions() {
      // 고유 값 추출
      const vendors = [...new Set(rawRows.map(r => r.vendor).filter(Boolean))].sort((a,b)=>a.localeCompare(b, 'ko'));
      const cats = [...new Set(rawRows.map(r => r.category).filter(Boolean))].sort((a,b)=>a.localeCompare(b, 'ko'));

      vendorList.innerHTML = vendors.map(v => `<option value="${v}"></option>`).join("");
      catList.innerHTML = cats.map(v => `<option value="${v}"></option>`).join("");
    }

    function activeFilterChips() {
      const chips = [];
      if (vendorInput.value) chips.push(`<span class="chip">구매처명: ${escapeHtml(vendorInput.value)}</span>`);
      if (catInput.value) chips.push(`<span class="chip">대분류: ${escapeHtml(catInput.value)}</span>`);
      if (globalSearch.value) chips.push(`<span class="chip">검색: “${escapeHtml(globalSearch.value)}”</span>`);
      $("#activeFilters").innerHTML = chips.join("");
    }

    function applyFiltersAndRender() {
      const vFilter = norm(vendorInput.value);
      const cFilter = norm(catInput.value);
      const q = norm(globalSearch.value).toLowerCase();

      viewRows = rawRows.filter(r => {
        const vendorOk = !vFilter || r.vendor === vFilter;
        const catOk = !cFilter || r.category === cFilter;
        const text = [r.vendor, r.category, r.project, r.type, r.unit, r.grade, r.note, r.unitPrice, r.qty, fmtDate(r.poDate)].join(" \u241F ").toLowerCase();
        const qOk = !q || text.includes(q);
        return vendorOk && catOk && qOk;
      });

      sortRows();
      renderTable();
      countShown.textContent = viewRows.length.toLocaleString('ko-KR');
      activeFilterChips();
    }

    function renderTable() {
      const rowsHtml = viewRows.map(r => `
        <tr>
          <td>${fmtDate(r.poDate)}</td>
          <td>${escapeHtml(r.project)}</td>
          <td>${escapeHtml(r.type)}</td>
          <td class="right">${fmtKRW(r.unitPrice)}</td>
          <td>${escapeHtml(r.unit)}</td>
          <td>${escapeHtml(r.grade)}</td>
          <td class="right">${fmtQty(r.qty)}</td>
          <td>${escapeHtml(r.note)}</td>
          <td class="hidden">${escapeHtml(r.vendor)}</td>
          <td class="hidden">${escapeHtml(r.category)}</td>
        </tr>`).join("");
      tbody.innerHTML = rowsHtml || `<tr><td colspan="10" style="text-align:center;color:var(--muted);padding:22px;">조건에 맞는 데이터가 없습니다.</td></tr>`;
    }

    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"] /g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]||c));
    }

    // ====== 이벤트 바인딩 ======
    $("#file").addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf);
      loadSheet(wb);
    });

    vendorInput.addEventListener('input', applyFiltersAndRender);
    catInput.addEventListener('input', applyFiltersAndRender);
    globalSearch.addEventListener('input', applyFiltersAndRender);

    sortBtn.addEventListener('click', () => {
      sortAsc = !sortAsc;
      sortBtn.textContent = `PO생성일 ${sortAsc ? '⬆' : '⬇'}`;
      sortRows();
      renderTable();
    });

    resetBtn.addEventListener('click', () => {
      vendorInput.value = "";
      catInput.value = "";
      globalSearch.value = "";
      applyFiltersAndRender();
    });

    reloadBtn.addEventListener('click', () => {
      loadDefault();
    });

    // ====== 기본 파일(data.xlsx) 로드 ======
    async function loadDefault() {
      try {
        const res = await fetch('data.xlsx');
        if (!res.ok) throw new Error('기본 파일(data.xlsx)을 찾을 수 없습니다. 상단에서 파일을 선택하세요.');
        const buf = await res.arrayBuffer();
        const wb = XLSX.read(buf);
        loadSheet(wb);
      } catch (err) {
        console.warn(err);
        // 빈 표시 초기화
        rawRows = [];
        viewRows = [];
        tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;color:var(--muted);padding:22px;">기본 파일을 찾을 수 없습니다. 상단에서 Excel 파일을 선택하세요.</td></tr>`;
        countShown.textContent = '0';
        countTotal.textContent = '0';
      }
    }

    // 초기 로드
    loadDefault();
  </script>
</body>
</html>
