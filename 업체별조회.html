<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>êµ¬ë§¤ ì´ë ¥ ì¡°íšŒ Â· ì—…ì²´ ë“œë¡­ë‹¤ìš´ + ì „ì²´ ê²€ìƒ‰</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root {
    --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af;
    --brand:#60a5fa; --border:#1f2937;
  }
  *{box-sizing:border-box;}
  body{background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    margin:0;}
  header{padding:18px 20px;border-bottom:1px solid var(--border);
    position:sticky;top:0;background:linear-gradient(180deg,rgba(15,23,42,.98),rgba(15,23,42,.92));
    backdrop-filter:blur(6px);z-index:10;}
  h1{margin:0 0 10px;font-size:20px;font-weight:700;}
  .controls{display:grid;gap:10px;grid-template-columns:1fr 1.2fr 1fr;}
  .controls label{font-size:12px;color:var(--muted);}
  .control{display:grid;gap:6px;}
  select,input[type="search"],input[list],button,input[type="file"]{
    background:#0b1220;border:1px solid var(--border);color:var(--ink);
    padding:10px 12px;border-radius:12px;outline:none;font-size:14px;}
  select{cursor:pointer;}
  select option{background:#0b1220;color:var(--ink);}
  button.primary{background:var(--brand);border-color:transparent;color:#0b1220;font-weight:700;}
  button.ghost{background:transparent;border:1px solid var(--border);}
  main{padding:16px 20px 80px;}
  table{width:100%;border-collapse:collapse;background:#0b1220;border:1px solid var(--border);
    border-radius:12px;overflow:hidden;}
  th{position:sticky;top:0;background:#0d1526;color:var(--muted);font-weight:600;font-size:12px;
    border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;cursor:pointer;
    user-select:none;}
  th:hover{background:#111b33;color:var(--brand);}
  th.sortable::after{content:" â¬";opacity:0.3;margin-left:4px;}
  th.sort-asc::after{content:" â¬†";opacity:1;}
  th.sort-desc::after{content:" â¬‡";opacity:1;}
  tbody td{padding:10px 8px;border-bottom:1px solid var(--border);font-size:14px;}
  tbody tr:hover{background:rgba(96,165,250,0.08);}
  .right{text-align:right;}
  .hidden{display:none;}
  .footer{position:fixed;bottom:12px;right:12px;display:flex;gap:8px;}
  .debug-info{background:#1a1a2e;border:1px solid var(--border);padding:12px;margin:12px 0;
    border-radius:8px;font-family:monospace;font-size:12px;color:#fbbf24;}
</style>
</head>
<body>
<header id="pageHeader">
  <h1>êµ¬ë§¤ ì´ë ¥ ì¡°íšŒ Â· ì—…ì²´ ë“œë¡­ë‹¤ìš´ + ì „ì²´ ê²€ìƒ‰</h1>
  <div class="controls">
    <div class="control">
      <label>ë°ì´í„° íŒŒì¼ (Excel .xlsx) â€” ê¸°ë³¸: data.xlsx (GitHub)</label>
      <input id="file" type="file" accept=".xlsx,.xls" />
    </div>
    <div class="control">
      <label>êµ¬ë§¤ì²˜ëª… (ë“œë¡­ë‹¤ìš´ ì„ íƒ)</label>
      <select id="vendorSelect">
        <option value="">ëª¨ë“  êµ¬ë§¤ì²˜</option>
      </select>
    </div>
    <div class="control">
      <label>ì „ì²´ ë°ì´í„° ê²€ìƒ‰ (ë¶€ë¶„ ì¼ì¹˜)</label>
      <input id="globalSearch" type="search" placeholder="í”„ë¡œì íŠ¸ëª…, ë¶„ë¥˜, ë¹„ê³  ë“± í‚¤ì›Œë“œ" />
    </div>
  </div>
  <div class="summary">
    <span id="countShown">0</span>ê±´ / ì´ <span id="countTotal">0</span>ê±´
  </div>
  <div id="debugInfo" class="debug-info" style="display:none;"></div>
</header>

<main>
  <table id="table">
    <thead>
      <tr>
        <th class="sortable" data-key="poDate">POìƒì„±ì¼</th>
        <th class="sortable" data-key="projectCode">í”„ë¡œì íŠ¸ì½”ë“œ</th>
        <th class="sortable" data-key="project">í”„ë¡œì íŠ¸ëª…</th>
        <th class="sortable" data-key="type">ë¶„ë¥˜</th>
        <th class="sortable right" data-key="unitPrice">ì„œë¹„ìŠ¤ë‹¨ê°€</th>
        <th class="sortable" data-key="unit">ì„œë¹„ìŠ¤ë‹¨ìœ„</th>
        <th class="sortable" data-key="grade">ì„œë¹„ìŠ¤ ë“±ê¸‰ë‚´ì—­</th>
        <th class="sortable right" data-key="qty">ì„œë¹„ìŠ¤ìˆ˜ëŸ‰</th>
        <th class="sortable" data-key="note">ë¹„ê³ </th>
        <th class="hidden">êµ¬ë§¤ì²˜ëª…</th>
        <th class="hidden">ëŒ€ë¶„ë¥˜</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</main>

<div class="footer">
  <button id="resetBtn" class="ghost">í•„í„° ì´ˆê¸°í™”</button>
  <button id="reloadBtn" class="primary">ê¸°ë³¸íŒŒì¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
</div>

<script>
const DEFAULT_URL = () => `data.xlsx?ts=${Date.now()}`;
const PREFERRED_SHEET_NAMES = ["ì™¸ì£¼ìš©ì—­","Sheet1","data","DATA"];
const HEADER_MAP = {
  vendor:["êµ¬ë§¤ì²˜ëª…","ì—…ì²´","ë²¤ë”","Vendor","ë§¤ì…ì²˜"],
  category:["ëŒ€ë¶„ë¥˜","ë¶„ë¥˜(ëŒ€)","Category","ì¹´í…Œê³ ë¦¬"],
  poDate:["POìƒì„±ì¼","ë°œì£¼ìƒì„±ì¼","ì£¼ë¬¸ì¼","PO Date","POì¼ì"],
  projectCode:["í”„ë¡œì íŠ¸ì½”ë“œ","í”„ë¡œì íŠ¸ ì½”ë“œ","Project Code","ì‚¬ì—…ì½”ë“œ"],
  project:["í”„ë¡œì íŠ¸ëª…","ì‚¬ì—…ëª…","í”„ë¡œì íŠ¸","Project"],
  type:["ë¶„ë¥˜","ì†Œë¶„ë¥˜","Type"],
  unitPrice:["ì„œë¹„ìŠ¤ë‹¨ê°€","ë‹¨ê°€","UnitPrice","ê¸ˆì•¡"],
  unit:["ì„œë¹„ìŠ¤ë‹¨ìœ„","ë‹¨ìœ„","Unit"],
  grade:["ì„œë¹„ìŠ¤ ë“±ê¸‰ë‚´ì—­","ì„œë¹„ìŠ¤ë“±ê¸‰ë‚´ì—­","ì„œë¹„ìŠ¤ ë“±ê¸‰ ë‚´ì—­","ì„œë¹„ìŠ¤ë“±ê¸‰ ë‚´ì—­","ë“±ê¸‰ë‚´ì—­","ë“±ê¸‰","Grade","grade","ì„œë¹„ìŠ¤ë“±ê¸‰","ì„œë¹„ìŠ¤ ë“±ê¸‰"],
  qty:["ì„œë¹„ìŠ¤ìˆ˜ëŸ‰","ìˆ˜ëŸ‰","Qty","ìˆ˜ëŸ‰(EA)"],
  note:["ë¹„ê³ ","ë©”ëª¨","Remark","Note"]
};

let rawRows=[],viewRows=[];
let sortKey='poDate',sortAsc=false;

const $=(s)=>document.querySelector(s);
const tbody=$("#tbody");
const vendorSelect=$("#vendorSelect");
const globalSearch=$("#globalSearch");
const countShown=$("#countShown");
const countTotal=$("#countTotal");
const debugInfo=$("#debugInfo");

const fmtKRW=(n)=>(n===null||n===undefined||n==="")?"":new Intl.NumberFormat('ko-KR',{maximumFractionDigits:0}).format(Number(n))+"ì›";
const fmtQty=(n)=>(n===null||n===undefined||n==="")?"":new Intl.NumberFormat('ko-KR',{maximumFractionDigits:2}).format(Number(n));
const parseDate=(v)=>{if(!v&&v!==0)return null;if(typeof v==='number'){const d=XLSX.SSF.parse_date_code(v);return new Date(d.y,d.m-1,d.d);}const s=String(v).trim().replaceAll(".","-").replaceAll("/","-");const dt=new Date(s);return isNaN(dt)?null:dt;};
const fmtDate=(d)=>!d?"":d.toISOString().slice(0,10);
const norm=(s)=>(s??"").toString().trim();

function showDebug(message){
  debugInfo.style.display='block';
  debugInfo.innerHTML+=message+'<br>';
  console.log(message);
}

function detectHeaders(headerRow){
  const normalizeForMatch=(s)=>String(s??"").toLowerCase()
    .replace(/[\u00A0\u1680\u180E\u2000-\u200B\u202F\u205F\u3000]/g,' ')
    .replace(/\s+/g,' ')
    .trim();
  const h={};
  const row=headerRow.map(h=>normalizeForMatch(h));
  
  showDebug(`ğŸ“‹ ì‹¤ì œ í—¤ë”: ${JSON.stringify(headerRow)}`);
  showDebug(`ğŸ”„ ì •ê·œí™”ëœ í—¤ë”: ${JSON.stringify(row)}`);
  
  for(const [key,aliases] of Object.entries(HEADER_MAP)){
    let idx=-1;
    for(const a of aliases){
      const i=row.indexOf(normalizeForMatch(a));
      if(i!==-1){
        idx=i;
        if(key==='grade'||key==='projectCode') showDebug(`âœ… '${key}' ë§¤ì¹­ ì„±ê³µ: "${a}" â†’ ì¸ë±ìŠ¤ ${idx}`);
        break;
      }
    }
    if(idx===-1){
      const noSpaceRow=row.map(x=>x.replace(/\s+/g,''));
      for(const a of aliases){
        const i=noSpaceRow.indexOf(normalizeForMatch(a).replace(/\s+/g,''));
        if(i!==-1){
          idx=i;
          if(key==='grade'||key==='projectCode') showDebug(`âœ… '${key}' ë§¤ì¹­ ì„±ê³µ (ê³µë°±ì œê±°): "${a}" â†’ ì¸ë±ìŠ¤ ${idx}`);
          break;
        }
      }
    }
    h[key]=idx;
  }
  
  if(h.grade===-1){
    showDebug("âŒ [ì˜¤ë¥˜] 'ì„œë¹„ìŠ¤ ë“±ê¸‰ë‚´ì—­' ì—´ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤!");
  }
  if(h.projectCode===-1){
    showDebug("âš ï¸ [ê²½ê³ ] 'í”„ë¡œì íŠ¸ì½”ë“œ' ì—´ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
  }
  
  showDebug(`ğŸ” ìµœì¢… ì»¬ëŸ¼ ë§¤ì¹­: ${JSON.stringify(h)}`);
  return h;
}

function loadSheet(wb){
  debugInfo.innerHTML='';
  debugInfo.style.display='none';
  
  const name=wb.SheetNames.find(n=>PREFERRED_SHEET_NAMES.includes(n))||wb.SheetNames[0];
  showDebug(`ğŸ“Š ë¡œë“œëœ ì‹œíŠ¸: "${name}"`);
  
  const sheet=wb.Sheets[name];
  const rows=XLSX.utils.sheet_to_json(sheet,{header:1,defval:""});
  if(!rows.length) return;
  
  const map=detectHeaders(rows[0]);
  
  rawRows=rows.slice(1).map((r,idx)=>{
    const obj={
      vendor:norm(r[map.vendor]),
      category:norm(r[map.category]),
      poDate:parseDate(r[map.poDate]),
      projectCode:map.projectCode!==-1?norm(r[map.projectCode]):"",
      project:norm(r[map.project]),
      type:norm(r[map.type]),
      unitPrice:r[map.unitPrice]===""?"":Number(String(r[map.unitPrice]).replace(/[^\d.-]/g,"")),
      unit:norm(r[map.unit]),
      grade:map.grade!==-1?norm(r[map.grade]):"",
      qty:r[map.qty]===""?"":Number(String(r[map.qty]).replace(/[^\d.-]/g,"")),
      note:norm(r[map.note])
    };
    
    if(idx<3 && (map.grade!==-1||map.projectCode!==-1)){
      if(map.projectCode!==-1) showDebug(`ğŸ“ í–‰ ${idx+1} projectCode: "${r[map.projectCode]}" â†’ "${obj.projectCode}"`);
      if(map.grade!==-1) showDebug(`ğŸ“ í–‰ ${idx+1} grade: "${r[map.grade]}" â†’ "${obj.grade}"`);
    }
    
    obj._search=[obj.vendor,obj.category,obj.projectCode,obj.project,obj.type,obj.unit,obj.grade,obj.note,obj.unitPrice,obj.qty,fmtDate(obj.poDate)].join(" ").toLowerCase();
    return obj;
  }).filter(r=>Object.values(r).some(v=>v!==""));
  
  populateVendorOptions();
  applyFiltersAndRender();
  countTotal.textContent=rawRows.length.toLocaleString('ko-KR');
}

function populateVendorOptions(){
  const vendors=[...new Set(rawRows.map(r=>r.vendor).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'ko'));
  vendorSelect.innerHTML='<option value="">ëª¨ë“  êµ¬ë§¤ì²˜</option>'+
    vendors.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
}

function sortRows(){
  viewRows.sort((a,b)=>{
    let av=a[sortKey];
    let bv=b[sortKey];
    
    if(sortKey==='poDate'){
      av=av?.getTime()??-Infinity;
      bv=bv?.getTime()??-Infinity;
      return sortAsc?av-bv:bv-av;
    }
    
    if(sortKey==='unitPrice'||sortKey==='qty'){
      av=av===""?-Infinity:Number(av);
      bv=bv===""?-Infinity:Number(bv);
      return sortAsc?av-bv:bv-av;
    }
    
    av=String(av??"");
    bv=String(bv??"");
    const cmp=av.localeCompare(bv,'ko');
    return sortAsc?cmp:-cmp;
  });
}

function applyFiltersAndRender(){
  const vFilter=norm(vendorSelect.value);
  const q=norm(globalSearch.value).toLowerCase();
  const qTokens=q?q.split(/\s+/):[];
  viewRows=rawRows.filter(r=>{
    const vendorOk=!vFilter||r.vendor===vFilter;
    let qOk=true;
    if(qTokens.length){qOk=qTokens.every(t=>r._search.includes(t));}
    return vendorOk&&qOk;
  });
  sortRows();
  renderTable();
  countShown.textContent=viewRows.length.toLocaleString('ko-KR');
}

function renderTable(){
  const html=viewRows.map(r=>`
  <tr>
    <td>${fmtDate(r.poDate)}</td>
    <td>${escapeHtml(r.projectCode)}</td>
    <td>${escapeHtml(r.project)}</td>
    <td>${escapeHtml(r.type)}</td>
    <td class="right">${fmtKRW(r.unitPrice)}</td>
    <td>${escapeHtml(r.unit)}</td>
    <td>${escapeHtml(r.grade)}</td>
    <td class="right">${fmtQty(r.qty)}</td>
    <td>${escapeHtml(r.note)}</td>
    <td class="hidden">${escapeHtml(r.vendor)}</td>
    <td class="hidden">${escapeHtml(r.category)}</td>
  </tr>`).join("");
  tbody.innerHTML=html||`<tr><td colspan="11" style="text-align:center;color:var(--muted);padding:22px;">ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
  updateSortIndicators();
}

function updateSortIndicators(){
  document.querySelectorAll('th.sortable').forEach(th=>{
    th.classList.remove('sort-asc','sort-desc');
    if(th.dataset.key===sortKey){
      th.classList.add(sortAsc?'sort-asc':'sort-desc');
    }
  });
}

function escapeHtml(s){return String(s??"").replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]||c));}

$("#file").addEventListener('change',async(e)=>{
  const f=e.target.files?.[0]; if(!f)return;
  const buf=await f.arrayBuffer(); const wb=XLSX.read(buf); loadSheet(wb);
});

vendorSelect.addEventListener('change',applyFiltersAndRender);
globalSearch.addEventListener('input',applyFiltersAndRender);

document.querySelectorAll('th.sortable').forEach(th=>{
  th.addEventListener('click',()=>{
    const key=th.dataset.key;
    if(sortKey===key){
      sortAsc=!sortAsc;
    }else{
      sortKey=key;
      sortAsc=false;
    }
    sortRows();
    renderTable();
  });
});

$("#resetBtn").addEventListener('click',()=>{
  vendorSelect.value="";
  globalSearch.value="";
  applyFiltersAndRender();
});

$("#reloadBtn").addEventListener('click',()=>{loadDefault();});

async function loadDefault(){
  try{
    const res=await fetch(DEFAULT_URL(),{cache:'no-store'});
    if(!res.ok)throw new Error('data.xlsxì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    const buf=await res.arrayBuffer();
    const wb=XLSX.read(buf);
    loadSheet(wb);
  }catch(e){
    console.warn(e);
    showDebug(`âš ï¸ ê¸°ë³¸ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ${e.message}`);
    tbody.innerHTML=`<tr><td colspan="11" style="text-align:center;color:var(--muted);padding:22px;">ê¸°ë³¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ ì§ì ‘ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>`;
  }
}
loadDefault();
</script>
</body>
</html>
