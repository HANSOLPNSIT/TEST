<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>외주용역 박스플롯 · 대분류 드롭다운 / 서비스등급 X축</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    :root {
      --bg: #0f172a;        /* slate-900 */
      --panel: #111827;     /* gray-900 */
      --ink: #e5e7eb;       /* gray-200 */
      --muted: #9ca3af;     /* gray-400 */
      --brand: #60a5fa;     /* blue-400 */
    }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; }
    header { padding: 18px 24px; border-bottom: 1px solid #1f2937; background: linear-gradient(180deg,#0f172a 0%, #0b1222 100%); }
    h1 { font-size: 18px; margin: 0 0 6px; }
    .wrap { display: grid; grid-template-columns: 320px 1fr; gap: 16px; padding: 18px 24px; }
    .card { background: var(--panel); border: 1px solid #1f2937; border-radius: 16px; padding: 16px; }
    label { display: block; margin: 10px 0 6px; color: var(--muted); font-size: 13px; }
    select, input[type="file"], button { width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid #374151; background: #0b1222; color: var(--ink); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    #plot { height: 72vh; }
    .hint { color: var(--muted); font-size: 12px; margin-top: 6px; line-height: 1.4; }
    .badge { display:inline-block; padding:2px 8px; border-radius:9999px; font-size:11px; background:#0b2546; color:#b9dcff; border:1px solid #1f3b66; }
    .footer { font-size: 12px; color: var(--muted); padding: 0 24px 24px; }
  </style>
</head>
<body>
  <header>
    <h1>외주용역 박스플롯</h1>
    <div class="hint">조건(드롭다운): <span class="badge">대분류=P열(분류)</span> · X축: <span class="badge">서비스등급=U열</span> · 데이터 행: <span class="badge">477–750행 (비어있으면 자동 무시)</span></div>
  </header>

  <div class="wrap">
    <section class="card">
      <div class="row">
        <div>
          <label>엑셀 파일 불러오기 (기본: 같은 폴더의 <strong>data.xlsx</strong>)</label>
          <input type="file" id="file" accept=".xlsx,.xls" />
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="loadDefault">기본 파일(data.xlsx) 읽기</button>
        </div>
      </div>
      <label>대분류(분류 · P열) 선택</label>
      <select id="category"></select>

      <label>측정값(숫자 컬럼) 선택 <span class="hint">박스플롯의 Y축 값으로 사용할 숫자 컬럼을 자동 탐지합니다.</span></label>
      <select id="metric"></select>

      <label>옵션</label>
      <div class="row">
        <div>
          <select id="orientation">
            <option value="v" selected>수직 박스(서비스등급 = X축)</option>
            <option value="h">수평 박스(서비스등급 = Y축)</option>
          </select>
        </div>
        <div>
          <select id="outliers">
            <option value="suspected" selected>이상치 표시</option>
            <option value="none">이상치 숨김</option>
          </select>
        </div>
      </div>

      <div class="hint">※ 헤더가 없어도 동작하지만, 헤더가 있으면 숫자 컬럼 자동 탐지가 더 정확합니다.<br/>※ 범위: 477–750행만 사용합니다(엑셀 기준 1행부터 시작).</div>
    </section>

    <section class="card">
      <div id="plot"></div>
    </section>
  </div>

  <div class="footer">Made for GitHub Pages · SheetJS + Plotly</div>

  <script>
    // --- 설정 상수 ---
    const EXCEL_SHEET_NAME = "외주용역"; // 시트명
    const ROW_START = 477; // 포함 (엑셀 1-based)
    const ROW_END   = 750; // 포함 (엑셀 1-based)
    const COL_P_IDX = 15;  // P열 = 0-based 15 (분류)
    const COL_U_IDX = 20;  // U열 = 0-based 20 (서비스등급)

    const els = {
      file: document.getElementById('file'),
      loadDefault: document.getElementById('loadDefault'),
      category: document.getElementById('category'),
      metric: document.getElementById('metric'),
      orientation: document.getElementById('orientation'),
      outliers: document.getElementById('outliers'),
      plot: document.getElementById('plot'),
    };

    let state = {
      headers: [],        // 헤더 행(Array) 또는 자동 생성
      rows: [],           // 2차원 배열 (header:1 기반)
      categoryValues: [], // P열 고유값
      numericCols: [],    // 숫자형 컬럼 인덱스 목록
    };

    // 유틸: 고유값 추출
    function unique(arr) {
      return Array.from(new Set(arr.filter(v => v !== undefined && v !== null && String(v).trim() !== '')));
    }

    // 유틸: 숫자 여부
    function isNumeric(val){
      return typeof val === 'number' && isFinite(val);
    }

    // 엑셀 파일 로드 (ArrayBuffer)
    async function loadWorkbookFromArrayBuffer(ab) {
      const wb = XLSX.read(ab, { type: 'array' });
      const sheetName = wb.Sheets[EXCEL_SHEET_NAME] ? EXCEL_SHEET_NAME : wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];

      // header:1 => 2차원 배열 [ [c0,c1,...], [..], ... ]
      const rows = XLSX.utils.sheet_to_json(ws, { header:1, raw: true, defval: null });
      return rows;
    }

    // 파일 인풋 핸들러
    els.file.addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      const ab = await f.arrayBuffer();
      const rows = await loadWorkbookFromArrayBuffer(ab);
      ingestRows(rows);
    });

    // 기본 data.xlsx 읽기
    els.loadDefault.addEventListener('click', async () => {
      try {
        const res = await fetch('data.xlsx');
        if (!res.ok) throw new Error('data.xlsx를 찾을 수 없습니다. 같은 폴더에 위치시켜 주세요.');
        const ab = await res.arrayBuffer();
        const rows = await loadWorkbookFromArrayBuffer(ab);
        ingestRows(rows);
      } catch (err) {
        alert(err.message || err);
      }
    });

    // 행 데이터 주입 및 UI 구성
    function ingestRows(rows){
      if (!rows || !rows.length) {
        alert('시트가 비어있습니다.');
        return;
      }
      // 헤더 추정: 첫 행에 문자열이 더 많으면 헤더로 간주
      const first = rows[0] || [];
      const headerLike = first.some(v => typeof v === 'string');

      let headerRow = headerLike ? first : [];
      let data = headerLike ? rows.slice(1) : rows.slice();

      // Excel 1-based 행번호 477~750 (포함) => 배열 0-based로 환산
      const startIdx = ROW_START - 1 - (headerLike ? 1 : 0);
      const endIdx = ROW_END - 1 - (headerLike ? 1 : 0);

      const slice = data.filter((_, i) => i >= startIdx && i <= endIdx);

      state.rows = slice;
      state.headers = headerRow.length ? headerRow : generateFallbackHeaders(rows[0]?.length || guessMaxCols(slice));

      // P열(분류), U열(서비스등급)에서 값 가져오기 (비어있으면 제외)
      const pVals = slice.map(r => r[COL_P_IDX]).filter(v => v !== null && v !== undefined && String(v).trim() !== '');
      const uVals = slice.map(r => r[COL_U_IDX]).filter(v => v !== null && v !== undefined && String(v).trim() !== '');

      state.categoryValues = unique(pVals).sort(naturalCompare);

      // 숫자형 컬럼 자동 탐지
      state.numericCols = detectNumericColumns(slice);

      populateCategorySelect();
      populateMetricSelect();

      draw();
    }

    function guessMaxCols(rows){
      return Math.max(0, ...rows.map(r => (Array.isArray(r) ? r.length : 0)));
    }

    function generateFallbackHeaders(n){
      // A,B,C,... 스타일 헤더
      const labels = [];
      for (let i=0;i<n;i++) labels.push(columnLabel(i));
      return labels;
    }

    function columnLabel(idx){
      // 0 -> A, 25 -> Z, 26 -> AA
      let s = '';
      let n = idx;
      while (n >= 0) {
        s = String.fromCharCode((n % 26) + 65) + s;
        n = Math.floor(n / 26) - 1;
      }
      return s;
    }

    function naturalCompare(a,b){
      return String(a).localeCompare(String(b), 'ko', { numeric: true, sensitivity: 'base' });
    }

    function detectNumericColumns(rows){
      const maxCols = guessMaxCols(rows);
      const numericIdx = [];
      for (let c=0;c<maxCols;c++){
        // 표본 50개까지 검사
        let nums = 0, vals = 0;
        for (let r=0;r<rows.length && r<50;r++){
          const v = rows[r][c];
          if (v === null || v === undefined || v === '') continue;
          vals++;
          if (typeof v === 'number' && isFinite(v)) nums++;
          else if (typeof v === 'string' && v.trim() !== '' && !isNaN(+v)) { nums++; rows[r][c] = +v; }
        }
        if (vals > 0 && nums/Math.max(1,vals) >= 0.8) numericIdx.push(c);
      }
      return numericIdx;
    }

    function populateCategorySelect(){
      els.category.innerHTML = '';
      // 전체 보기 옵션
      const optAll = document.createElement('option');
      optAll.value = '__ALL__';
      optAll.textContent = `전체 (${state.categoryValues.length}개 분류)`;
      els.category.appendChild(optAll);

      state.categoryValues.forEach(v => {
        const o = document.createElement('option');
        o.value = String(v);
        o.textContent = String(v);
        els.category.appendChild(o);
      });

      els.category.value = '__ALL__';
      els.category.onchange = draw;
    }

    function populateMetricSelect(){
      els.metric.innerHTML = '';
      if (!state.numericCols.length){
        const o = document.createElement('option');
        o.value = '-1';
        o.textContent = '숫자 컬럼을 찾지 못했습니다 (헤더 확인)';
        els.metric.appendChild(o);
        return;
      }
      state.numericCols.forEach(idx => {
        const o = document.createElement('option');
        const name = state.headers[idx] ?? columnLabel(idx);
        o.value = String(idx);
        o.textContent = `${name} (열 ${columnLabel(idx)})`;
        els.metric.appendChild(o);
      });
      els.metric.value = String(state.numericCols[0]);
      els.metric.onchange = draw;
      els.orientation.onchange = draw;
      els.outliers.onchange = draw;
    }

    function draw(){
      if (!state.rows.length) {
        Plotly.purge(els.plot);
        return;
      }
      const catSel = els.category.value;
      const metricIdx = +els.metric.value;
      const orient = els.orientation.value; // 'v' or 'h'
      const showOutliers = els.outliers.value !== 'none';

      if (Number.isNaN(metricIdx) || metricIdx < 0){
        Plotly.purge(els.plot);
        els.plot.innerHTML = '<div style="padding:12px;color:#9ca3af;">숫자 컬럼을 선택해 주세요.</div>';
        return;
      }

      // 분류(P열) 필터
      const filtered = state.rows.filter(r => {
        const p = r[COL_P_IDX];
        const u = r[COL_U_IDX];
        const y = r[metricIdx];
        if (p === null || p === undefined || String(p).trim() === '') return false;
        if (u === null || u === undefined || String(u).trim() === '') return false;
        if (y === null || y === undefined || y === '' || !isFinite(+y)) return false;
        return catSel === '__ALL__' || String(p) === catSel;
      });

      // 서비스등급(U열)별로 그룹화
      const byGrade = new Map();
      for (const r of filtered){
        const grade = String(r[COL_U_IDX]).trim();
        const val = +r[metricIdx];
        if (!byGrade.has(grade)) byGrade.set(grade, []);
        byGrade.get(grade).push(val);
      }

      // 빈 그룹 제거
      const grades = Array.from(byGrade.keys()).sort(naturalCompare);
      const traces = grades.map(g => {
        const arr = byGrade.get(g).filter(isFinite);
        if (!arr.length) return null;
        const t = {
          type: 'box',
          name: g,
          boxpoints: showOutliers ? 'suspectedoutliers' : false,
          jitter: 0.3,
          pointpos: 0,
          hovertemplate: `${g}<br>%{y}<extra></extra>`
        };
        if (orient === 'v') {
          t.y = arr;
        } else {
          t.x = arr;
          t.orientation = 'h';
        }
        return t;
      }).filter(Boolean);

      const titleCat = (catSel === '__ALL__') ? '전체 분류' : `분류: ${catSel}`;
      const metricName = state.headers[metricIdx] ?? `열 ${columnLabel(metricIdx)}`;

      const layout = {
        paper_bgcolor: '#0f172a',
        plot_bgcolor: '#0f172a',
        font: { color: '#e5e7eb' },
        margin: { t: 48, r: 24, b: 72, l: 72 },
        title: `${titleCat} · Y축: ${metricName}`,
        xaxis: {
          title: (els.orientation.value === 'v') ? '서비스등급 (U열)' : metricName,
          gridcolor: '#1f2937', zerolinecolor: '#1f2937'
        },
        yaxis: {
          title: (els.orientation.value === 'v') ? metricName : '서비스등급 (U열)',
          gridcolor: '#1f2937', zerolinecolor: '#1f2937'
        },
        showlegend: false
      };

      if (!traces.length){
        Plotly.purge(els.plot);
        els.plot.innerHTML = '<div style="padding:12px;color:#9ca3af;">선택한 조건에서 표시할 데이터가 없습니다.</div>';
        return;
      }

      Plotly.react(els.plot, traces, layout, {responsive: true, displaylogo:false});
    }

    // 페이지 로드 후 즉시 기본 파일 시도 (있으면 자동 로드)
    (async function tryAutoLoad(){
      try {
        const res = await fetch('data.xlsx', { method: 'HEAD' });
        if (res.ok) {
          const get = await fetch('data.xlsx');
          const ab = await get.arrayBuffer();
          const rows = await loadWorkbookFromArrayBuffer(ab);
          ingestRows(rows);
        }
      } catch (e) {
        // 무시: 기본 파일 없으면 사용자가 업로드하면 됨
      }
    })();
  </script>
</body>
</html>
