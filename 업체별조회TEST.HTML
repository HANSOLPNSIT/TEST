<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>구매 이력 조회 · 업체 드롭다운 + 전체 검색</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#0f172a;--panel:#111827;--ink:#e5e7eb;--muted:#9ca3af;--brand:#60a5fa;--border:#1f2937;
      --safe-top-gap:28px; --col0-w:120px; --col1-w:220px; --thead-top:74px; /* 동적 보정값(초깃값) */
    }
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;margin:0}
    header{padding:18px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:linear-gradient(180deg,rgba(15,23,42,.98),rgba(15,23,42,.92));backdrop-filter:blur(6px);z-index:10;margin-top:var(--safe-top-gap)}
    h1{margin:0 0 10px;font-size:20px;font-weight:700;letter-spacing:.2px}
    .controls{display:grid;gap:10px;grid-template-columns:1fr 1.2fr 1fr;align-items:center}
    .controls label{font-size:12px;color:var(--muted)}
    .control{display:grid;gap:6px}
    input[type="search"],select,button,input[type="file"]{background:#0b1220;border:1px solid var(--border);color:var(--ink);padding:10px 12px;border-radius:12px;outline:none;font-size:14px}
    input[type="file"]{padding:8px 10px}
    button{cursor:pointer;transition:.2s ease}
    button.primary{background:var(--brand);border-color:transparent;color:#0b1220;font-weight:700}
    button.ghost{background:transparent;border-color:var(--border)}
    main{padding:16px 20px 80px}
    .summary{font-size:13px;color:var(--muted);margin:10px 0 16px}

    .table-wrap{overflow-x:auto;border-radius:16px}
    table{width:100%;border-collapse:separate;border-spacing:0;background:#0b1220;border:1px solid var(--border);border-radius:16px;min-width:900px;table-layout:fixed}
    thead th{
      position:sticky;
      top:var(--thead-top);   /* 캡처 2: 항상 데이터 위에 고정 */
      background:#0d1526;color:var(--muted);font-weight:600;font-size:12px;letter-spacing:.2px;
      border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;z-index:3
    }
    tbody td{padding:10px 8px;border-bottom:1px solid var(--border);font-size:14px}
    tbody tr:hover{background:rgba(96,165,250,0.08)}
    .right{text-align:right}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--ink);background:#0f1a2f}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 4px}
    .chip{border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    .hidden{display:none !important}
    .count{font-variant-numeric:tabular-nums}
    .footer{position:fixed;bottom:12px;right:12px;display:flex;gap:8px}
    .vendor-info{margin-top:6px;font-size:13px;color:var(--ink)}
    .vendor-info .muted{color:var(--muted)}
    col.col0{width:var(--col0-w)}
    col.col1{width:var(--col1-w)}
    th.sticky-col,td.sticky-col{position:sticky;background:#0d1526;z-index:2}
    th.col-0,td.col-0{left:0;min-width:var(--col0-w)}
    th.col-1,td.col-1{left:calc(var(--col0-w));min-width:var(--col1-w)}
    tbody td.sticky-col{background:#0b1220}
    tbody tr:hover td.sticky-col{background:rgba(96,165,250,0.08)}
  </style>
</head>
<body>
  <header id="pageHeader">
    <h1>구매 이력 조회 · 업체 드롭다운 + 전체 검색</h1>
    <div class="controls">
      <div class="control">
        <label>데이터 파일 (Excel .xlsx) — 기본: <code>data.xlsx</code> (GitHub)</label>
        <input id="file" type="file" accept=".xlsx,.xls" />
      </div>

      <!-- (1) 구매처 드롭다운: 선택 시 자동 재조회 -->
      <div class="control">
        <label>구매처명 (드롭다운 선택)</label>
        <select id="vendorSelect">
          <option value="">모든 구매처</option>
        </select>
        <div id="vendorInfo" class="vendor-info muted"></div>
      </div>

      <div class="control">
        <label>전체 데이터 검색 (단어 일치)</label>
        <input id="globalSearch" type="search" placeholder="프로젝트명, 분류, 비고 등 키워드" />
      </div>
    </div>
    <div class="chips" id="activeFilters" aria-live="polite"></div>
    <div class="summary"><span class="count" id="countShown">0</span>건 / 총 <span class="count" id="countTotal">0</span>건 · 정렬: <button class="ghost" id="sortBtn" title="PO생성일 정렬 전환">PO생성일 ⬇</button></div>
  </header>

  <main>
    <div class="table-wrap">
      <table id="table" aria-describedby="countShown countTotal">
        <colgroup>
          <col class="col0"/><col class="col1"/><col/><col/><col/><col/><col/><col/><col/><col/>
        </colgroup>
        <thead>
          <tr>
            <th class="sticky-col col-0">PO생성일</th>
            <th class="sticky-col col-1">프로젝트명</th>
            <th>분류</th>
            <th class="right">서비스단가</th>
            <th>서비스단위</th>
            <th>서비스등급내역</th><!-- (3) 값 채워지도록 매핑 보강 -->
            <th class="right">서비스수량</th>
            <th>비고</th>
            <th class="hidden">구매처명</th>
            <th class="hidden">대분류</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>

  <div class="footer">
    <button id="resetBtn" class="ghost">필터 초기화</button>
    <button id="reloadBtn" class="primary">기본파일 다시 불러오기</button>
  </div>

  <script>
    const DEFAULT_URL = () => `data.xlsx?ts=${Date.now()}`; // GitHub Pages 캐시 무효화
    const PREFERRED_SHEET_NAMES = ["외주용역","Sheet1","data","DATA"];

    // (3) '서비스등급내역' 표기 변형까지 모두 매핑
    const HEADER_MAP = {
      vendor:["구매처명","업체","벤더","Vendor","매입처"],
      category:["대분류","분류(대)","Category","카테고리"],
      poDate:["PO생성일","발주생성일","주문일","PO Date","PO일자"],
      project:["프로젝트명","사업명","프로젝트","Project"],
      type:["분류","소분류","Type"],
      unitPrice:["서비스단가","단가","UnitPrice","금액"],
      unit:["서비스단위","단위","Unit"],
      grade:["서비스등급내역","서비스 등급 내역","서비스등급 내역","등급","Grade","서비스 등급"],  // ★ 보강
      qty:["서비스수량","수량","Qty","수량(EA)"],
      note:["비고","메모","Remark","Note"]
    };

    let rawRows = [];
    let viewRows = [];
    let sortAsc = false;

    const $ = (s)=>document.querySelector(s);
    const headerEl = $("#pageHeader");
    const
