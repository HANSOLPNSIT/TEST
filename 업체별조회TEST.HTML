<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>업체별 이력조회2 · 데이터뷰셋 정렬(오름/내림)</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af; --brand:#60a5fa; --border:#1f2937;
    --good:#10b98133; --warn:#eab30833; --bad:#f8717137;
  }
  *{box-sizing:border-box}
  body{
    background:var(--bg); color:var(--ink);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    margin:0;
  }
  header{
    padding:16px 20px; border-bottom:1px solid var(--border);
    position:sticky; top:0; background:var(--bg); z-index:10;
  }
  header h1{margin:0 0 8px;font-size:18px;font-weight:700}
  .toolbar{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
  }
  .btn{
    background:#111827;border:1px solid var(--border);color:var(--ink);
    padding:8px 12px;border-radius:10px;cursor:pointer;
  }
  .btn:hover{border-color:#334155}
  .pill{
    padding:8px 12px;border-radius:999px;border:1px solid var(--border);
    background:#0b1226;color:var(--ink);
  }
  input[type="text"]{
    background:#0b1226;border:1px solid var(--border);color:var(--ink);
    padding:8px 12px;border-radius:10px;outline:none;min-width:220px;
  }
  main{padding:16px 20px}
  .tablewrap{
    border:1px solid var(--border); border-radius:14px; overflow:auto; background:var(--panel);
  }
  table{width:100%; border-collapse:collapse; font-size:14px}
  thead th{
    position:sticky; top:0; background:#0b1226; color:var(--ink);
    border-bottom:1px solid var(--border);
    padding:12px 10px; text-align:left; white-space:nowrap;
  }
  tbody td{
    border-top:1px solid var(--border);
    padding:10px; vertical-align:top;
  }
  th.sortable{ cursor:pointer; }
  th.sortable .arrow{ float:right; opacity:.9; }
  .muted{ color:var(--muted); }
  .badge{
    display:inline-block; padding:2px 8px; border-radius:999px;
    background:#0b1226; border:1px solid var(--border); font-size:12px;
  }
  .stats{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:10px 0 14px; }
  .hint{ color:var(--muted); font-size:12px; margin-top:8px; }
  .count{ font-weight:600 }
</style>
</head>
<body>
<header>
  <h1>업체별 이력조회2</h1>
  <div class="toolbar">
    <button class="btn" id="reloadBtn">기본 엑셀 로드(./data.xlsx)</button>
    <label class="btn" for="file">파일 선택</label>
    <input id="file" type="file" accept=".xlsx,.xls" style="display:none" />
    <input id="q" type="text" placeholder="전체 검색 (프로젝트명/구매처명/품목명 등)" />
    <span class="pill"><span class="count" id="rowCount">0</span>건</span>
  </div>
  <div class="hint">정렬: 헤더 클릭 시 ▲(오름)↔▼(내림) 토글 · 숫자/날짜/문자 자동 인식 · 빈값은 아래로</div>
</header>

<main>
  <div class="stats" id="stats"></div>
  <div class="tablewrap">
    <table id="grid">
      <thead>
        <tr>
          <!-- data-key는 객체 키와 일치하도록 -->
          <th class="sortable" data-key="PO생성일">PO생성일 <span class="arrow"></span></th>
          <th class="sortable" data-key="프로젝트명">프로젝트명 <span class="arrow"></span></th>
          <th class="sortable" data-key="구매처명">구매처명 <span class="arrow"></span></th>
          <th class="sortable" data-key="품목명">품목명 <span class="arrow"></span></th>
          <th class="sortable" data-key="수량">수량 <span class="arrow"></span></th>
          <th class="sortable" data-key="서비스단가">서비스단가 <span class="arrow"></span></th>
          <th class="sortable" data-key="금액">금액 <span class="arrow"></span></th>
          <th class="sortable" data-key="비고">비고 <span class="arrow"></span></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</main>

<script>
/* =========================
   0) 전역 상태
========================= */
let RAW = [];          // 원본 배열 [{PO생성일:..., 프로젝트명:..., ...}, ...]
let filtered = [];     // 검색/필터 후 배열
let sortKey = null;    // 현재 정렬 키
let sortDir = 'asc';   // 'asc' | 'desc'

/* =========================
   1) 유틸: 숫자/날짜/정렬
========================= */
function parseNumeric(v) {
  if (v == null) return NaN;
  if (typeof v === 'number') return v;
  const s = String(v).replace(/[^0-9.\-]/g, ''); // 숫자/소수점/음수만
  return s ? Number(s) : NaN;
}

// Excel serial ↔ Date(rough)
function parseDate(v) {
  if (v instanceof Date && !isNaN(v)) return v;
  if (typeof v === 'number' && v > 25569 && v < 80000) {
    const ms = Math.round((v - 25569) * 86400 * 1000);
    return new Date(ms);
  }
  const m = String(v).match(/^(\d{4})[./-](\d{1,2})[./-](\d{1,2})$/);
  if (m) return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
  return null;
}

// 빈값은 항상 뒤로
function isEmpty(v){
  return v == null || v === '' || (typeof v === 'string' && v.trim() === '');
}

function baseCompare(a, b) {
  const ea = isEmpty(a), eb = isEmpty(b);
  if (ea && eb) return 0;
  if (ea) return 1;
  if (eb) return -1;

  const na = parseNumeric(a), nb = parseNumeric(b);
  if (Number.isFinite(na) && Number.isFinite(nb)) return na - nb;

  const da = parseDate(a), db = parseDate(b);
  if (da && db) return da - db;

  return String(a).localeCompare(String(b), 'ko', { numeric:true, sensitivity:'base' });
}

function applySort(rows){
  if (!sortKey) return rows;
  const dir = (sortDir === 'asc') ? 1 : -1;
  return [...rows].sort((ra, rb) => baseCompare(ra[sortKey], rb[sortKey]) * dir);
}

// 통일된 표시 포맷(선택)
function fmtDate(v){
  const d = parseDate(v);
  if (!d) return (v ?? '');
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}
function fmtMoney(v){
  const n = parseNumeric(v);
  if (!Number.isFinite(n)) return v ?? '';
  return n.toLocaleString('ko-KR') + '원';
}

/* =========================
   2) 렌더
========================= */
const TBODY = document.querySelector('#grid tbody');
const COUNT = document.getElementById('rowCount');

function render(){
  // 검색어 반영
  const q = document.getElementById('q').value.trim().toLowerCase();
  filtered = RAW.filter(r => {
    if (!q) return true;
    // 프로젝트명/구매처명/품목명/비고 대상
    return ['프로젝트명','구매처명','품목명','비고'].some(k=>{
      return String(r[k] ?? '').toLowerCase().includes(q);
    });
  });

  // 정렬 적용
  const rows = applySort(filtered);

  // 그리드 렌더
  TBODY.innerHTML = '';
  const frag = document.createDocumentFragment();
  for (const r of rows){
    const tr = document.createElement('tr');

    const td0 = document.createElement('td'); td0.textContent = fmtDate(r['PO생성일']);
    const td1 = document.createElement('td'); td1.textContent = r['프로젝트명'] ?? '';
    const td2 = document.createElement('td'); td2.textContent = r['구매처명'] ?? '';
    const td3 = document.createElement('td'); td3.textContent = r['품목명'] ?? '';
    const td4 = document.createElement('td'); td4.textContent = Number.isFinite(parseNumeric(r['수량'])) ? parseNumeric(r['수량']).toLocaleString('ko-KR') : (r['수량'] ?? '');
    const td5 = document.createElement('td'); td5.textContent = fmtMoney(r['서비스단가']);
    const td6 = document.createElement('td'); td6.textContent = fmtMoney(r['금액']);
    const td7 = document.createElement('td'); td7.textContent = r['비고'] ?? '';

    tr.append(td0,td1,td2,td3,td4,td5,td6,td7);
    frag.appendChild(tr);
  }
  TBODY.appendChild(frag);
  COUNT.textContent = rows.length;

  paintHeaderArrows();
}

function paintHeaderArrows(){
  document.querySelectorAll('th.sortable').forEach(th=>{
    const key = th.dataset.key;
    const arrow = th.querySelector('.arrow');
    arrow.textContent = (key === sortKey) ? (sortDir === 'asc' ? '▲' : '▼') : '';
  });
}

/* =========================
   3) 이벤트: 정렬/검색
========================= */
document.querySelectorAll('th.sortable').forEach(th=>{
  th.addEventListener('click', ()=>{
    const key = th.dataset.key;
    if (sortKey === key){
      sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
    } else {
      sortKey = key;
      sortDir = 'asc'; // 첫 클릭은 오름차순
    }
    render();
  });
});

document.getElementById('q').addEventListener('input', ()=>{
  render();
});

/* =========================
   4) 데이터 로드
========================= */
async function readWorkbook(file){
  const data = await file.arrayBuffer();
  const wb = XLSX.read(data, {type:'array'});
  // 우선 첫 번째 시트 사용
  const wsname = wb.SheetNames[0];
  const ws = wb.Sheets[wsname];
  const arr = XLSX.utils.sheet_to_json(ws, {defval:''});
  // 컬럼명이 다를 수 있으니, 아래 키가 있으면 매핑하고 없으면 유추
  RAW = arr.map(row=>{
    return {
      'PO생성일': row['PO생성일'] ?? row['발주일'] ?? row['입력일자'] ?? row['Date'] ?? row['날짜'] ?? '',
      '프로젝트명': row['프로젝트명'] ?? row['프로젝트'] ?? row['Project'] ?? '',
      '구매처명'  : row['구매처명'] ?? row['업체명'] ?? row['거래처'] ?? row['Supplier'] ?? '',
      '품목명'    : row['품목명'] ?? row['항목'] ?? row['Item'] ?? '',
      '수량'      : row['수량'] ?? row['Qty'] ?? '',
      '서비스단가' : row['서비스단가'] ?? row['단가'] ?? row['UnitPrice'] ?? '',
      '금액'      : row['금액'] ?? row['합계'] ?? row['Amount'] ?? '',
      '비고'      : row['비고'] ?? row['메모'] ?? row['Remark'] ?? '',
    };
  });
  // 기본 정렬 키 설정(예: PO생성일 내림차순)
  sortKey = 'PO생성일';
  sortDir = 'desc';
  render();
}

async function fetchXlsx(url){
  const res = await fetch(url);
  if (!res.ok) throw new Error('엑셀 파일을 불러오지 못했습니다: ' + res.status);
  const buf = await res.arrayBuffer();
  const wb = XLSX.read(buf, {type:'array'});
  const wsname = wb.SheetNames[0];
  const ws = wb.Sheets[wsname];
  const arr = XLSX.utils.sheet_to_json(ws, {defval:''});
  RAW = arr.map(row=>{
    return {
      'PO생성일': row['PO생성일'] ?? row['발주일'] ?? row['입력일자'] ?? row['Date'] ?? row['날짜'] ?? '',
      '프로젝트명': row['프로젝트명'] ?? row['프로젝트'] ?? row['Project'] ?? '',
      '구매처명'  : row['구매처명'] ?? row['업체명'] ?? row['거래처'] ?? row['Supplier'] ?? '',
      '품목명'    : row['품목명'] ?? row['항목'] ?? row['Item'] ?? '',
      '수량'      : row['수량'] ?? row['Qty'] ?? '',
      '서비스단가' : row['서비스단가'] ?? row['단가'] ?? row['UnitPrice'] ?? '',
      '금액'      : row['금액'] ?? row['합계'] ?? row['Amount'] ?? '',
      '비고'      : row['비고'] ?? row['메모'] ?? row['Remark'] ?? '',
    };
  });
  sortKey = 'PO생성일';
  sortDir = 'desc';
  render();
}

// 파일 선택
document.getElementById('file').addEventListener('change', (e)=>{
  const file = e.target.files?.[0];
  if (file) readWorkbook(file);
});

// 기본 경로 로드 버튼
document.getElementById('reloadBtn').addEventListener('click', ()=>{
  // 👉 필요 시 여러분 저장소 경로로 변경
  fetchXlsx('./data.xlsx').catch(err=>{
    alert(err.message);
  });
});

/* =========================
   5) 데모 데이터(선택)
   - data.xlsx가 없을 때 페이지 확인용
========================= */
function loadDemo(){
  RAW = [
    {PO생성일:'2025-09-01', 프로젝트명:'에스텍 차세대 ERP', 구매처명:'디부', 품목명:'컨설팅', 수량:2, 서비스단가:2000000, 금액:4000000, 비고:''},
    {PO생성일:45590,        프로젝트명:'문서중앙화',       구매처명:'플로우아이티', 품목명:'S/W 라이선스', 수량:10, 서비스단가:'350,000원', 금액:'3,500,000원', 비고:'긴급'},
    {PO생성일:'2025-08-25', 프로젝트명:'삼성웰스토리 EHS', 구매처명:'단군소프트', 품목명:'AG-Grid Enterprise', 수량:5, 서비스단가:'1,200,000원', 금액:'6,000,000원', 비고:''},
    {PO생성일:'',           프로젝트명:'SAP 고도화',       구매처명:'코오롱베니트', 품목명:'외주개발', 수량:1, 서비스단가:10000000, 금액:10000000, 비고:'빈 날짜 테스트'},
    {PO생성일:'2025/07/03', 프로젝트명:'AI ATLAS',         구매처명:'유비앤티스랩', 품목명:'SSO 라이선스', 수량:3, 서비스단가:'2,500,000원', 금액:'7,500,000원', 비고:'검토'},
  ];
  sortKey = 'PO생성일';
  sortDir = 'desc';
  render();
}

// 초기: 해시로 xlsx 경로가 오면 로드, 아니면 데모
(function init(){
  const hash = decodeURIComponent(location.hash || '').replace(/^#/, '');
  // 예) #https://raw.githubusercontent.com/.../data.xlsx
  if (hash.endsWith('.xlsx') || hash.endsWith('.xls')){
    fetchXlsx(hash).catch(err=>{
      console.warn(err);
      loadDemo();
    });
  }else{
    loadDemo();
  }
})();
</script>
</body>
</html>
