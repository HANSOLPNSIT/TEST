<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>구매 이력 조회 · 업체 드롭다운 + 전체 검색</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --bg:#0f172a;--panel:#111827;--ink:#e5e7eb;--muted:#9ca3af;--brand:#60a5fa;--border:#1f2937;
    --safe-top-gap:28px; --col0-w:120px; --col1-w:220px; --thead-top:74px;
  }
  *{box-sizing:border-box}
  body{background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;margin:0}
  header{padding:18px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:linear-gradient(180deg,rgba(15,23,42,.98),rgba(15,23,42,.92));backdrop-filter:blur(6px);z-index:10;margin-top:var(--safe-top-gap)}
  h1{margin:0 0 10px;font-size:20px;font-weight:700;letter-spacing:.2px}
  .controls{display:grid;gap:10px;grid-template-columns:1fr 1.2fr 1fr;align-items:center}
  .controls label{font-size:12px;color:var(--muted)}
  .control{display:grid;gap:6px}
  input[type="search"],input[list],button,input[type="file"]{background:#0b1220;border:1px solid var(--border);color:var(--ink);padding:10px 12px;border-radius:12px;outline:none;font-size:14px}
  input[type="file"]{padding:8px 10px}
  button{cursor:pointer;transition:.2s ease}
  button.primary{background:var(--brand);border-color:transparent;color:#0b1220;font-weight:700}
  button.ghost{background:transparent;border-color:var(--border)}
  main{padding:16px 20px 80px}
  .summary{font-size:13px;color:var(--muted);margin:10px 0 16px}

  .table-wrap{overflow-x:auto;border-radius:16px}
  table{width:100%;border-collapse:separate;border-spacing:0;background:#0b1220;border:1px solid var(--border);border-radius:16px;min-width:900px;table-layout:fixed}
   th{
    position:sticky; top: 0;
    background:#0d1526;color:var(--muted);font-weight:600;font-size:12px;letter-spacing:.2px;
    border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;z-index:3
  }
  tbody td{padding:10px 8px;border-bottom:1px solid var(--border);font-size:14px}
  tbody tr:hover{background:rgba(96,165,250,0.08)}
  .right{text-align:right}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--ink);background:#0f1a2f}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 4px}
  .chip{border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
  .hidden{display:none !important}
  .count{font-variant-numeric:tabular-nums}
  .footer{position:fixed;bottom:12px;right:12px;display:flex;gap:8px}
  .vendor-info{margin-top:6px;font-size:13px;color:var(--ink)}
  .vendor-info .muted{color:var(--muted)}
  col.col0{width:var(--col0-w)} col.col1{width:var(--col1-w)}
  th.sticky-col,td.sticky-col{position:sticky;background:#0d1526;z-index:2}
  th.col-0,td.col-0{left:0;min-width:var(--col0-w)}
  th.col-1,td.col-1{left:calc(var(--col0-w));min-width:var(--col1-w)}
  tbody td.sticky-col{background:#0b1220}
  tbody tr:hover td.sticky-col{background:rgba(96,165,250,0.08)}
</style>
</head>
<body>
<header id="pageHeader">
  <h1>구매 이력 조회 · 업체 드롭다운 + 전체 검색</h1>
  <div class="controls">
    <div class="control">
      <label>데이터 파일 (Excel .xlsx) — 기본: <code>data.xlsx</code> (GitHub)</label>
      <input id="file" type="file" accept=".xlsx,.xls" />
    </div>

    <!-- 구매처: datalist 드롭다운(검색 가능) -->
    <div class="control">
      <label>구매처명 (드롭다운/검색 가능)</label>
      <input id="vendorInput" list="vendorList" placeholder="모든 구매처" />
      <datalist id="vendorList"></datalist>
      <div id="vendorInfo" class="vendor-info muted"></div>
    </div>

    <div class="control">
      <label>전체 데이터 검색 (부분 일치)</label>
      <input id="globalSearch" type="search" placeholder="프로젝트명, 분류, 비고 등 키워드" />
    </div>
  </div>
  <div class="chips" id="activeFilters" aria-live="polite"></div>
  <div class="summary"><span class="count" id="countShown">0</span>건 / 총 <span class="count" id="countTotal">0</span>건 · 정렬: <button class="ghost" id="sortBtn" title="PO생성일 정렬 전환">PO생성일 ⬇</button></div>
</header>

<main>
  <div class="table-wrap">
    <table id="table" aria-describedby="countShown countTotal">
      <colgroup><col class="col0"/><col class="col1"/><col/><col/><col/><col/><col/><col/><col/><col/></colgroup>
      <thead>
        <tr>
          <th class="sticky-col col-0">PO생성일</th>
          <th class="sticky-col col-1">프로젝트명</th>
          <th>분류</th>
          <th class="right">서비스단가</th>
          <th>서비스단위</th>
          <th>서비스 등급내역</th>
          <th class="right">서비스수량</th>
          <th>비고</th>
          <th class="hidden">구매처명</th>
          <th class="hidden">대분류</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</main>

<div class="footer">
  <button id="resetBtn" class="ghost">필터 초기화</button>
  <button id="reloadBtn" class="primary">기본파일 다시 불러오기</button>
</div>

<script>
  const DEFAULT_URL = () => `data.xlsx?ts=${Date.now()}`; // GitHub Pages 캐시 무효화
  const PREFERRED_SHEET_NAMES = ["외주용역","Sheet1","data","DATA"];
  const HEADER_MAP = {
    vendor:["구매처명","업체","벤더","Vendor","매입처"],
    category:["대분류","분류(대)","Category","카테고리"],
    poDate:["PO생성일","발주생성일","주문일","PO Date","PO일자"],
    project:["프로젝트명","사업명","프로젝트","Project"],
    type:["분류","소분류","Type"],
    unitPrice:["서비스단가","단가","UnitPrice","금액"],
    unit:["서비스단위","단위","Unit"],
    grade:["서비스 등급내역", "서비스등급내역"],
    qty:["서비스수량","수량","Qty","수량(EA)"],
    note:["비고","메모","Remark","Note"]
  };

  let rawRows=[], viewRows=[], sortAsc=false, vendorSet=new Set();

  const $=(s)=>document.querySelector(s);
  const headerEl=$("#pageHeader");
  const tbody=$("#tbody");
  const vendorInput=$("#vendorInput");
  const vendorList=$("#vendorList");
  const vendorInfo=$("#vendorInfo");
  const globalSearch=$("#globalSearch");
  const countShown=$("#countShown");
  const countTotal=$("#countTotal");
  const sortBtn=$("#sortBtn");

  const fmtKRW=(n)=>(n===null||n===undefined||n==="")?"":new Intl.NumberFormat('ko-KR',{maximumFractionDigits:0}).format(Number(n))+"원";
  const fmtQty=(n)=>(n===null||n===undefined||n==="")?"":new Intl.NumberFormat('ko-KR',{maximumFractionDigits:2}).format(Number(n));
  const parseDate=(v)=>{ if(!v&&v!==0) return null; if(typeof v==='number'){const d=XLSX.SSF.parse_date_code(v);return new Date(d.y,d.m-1,d.d);} const s=String(v).trim().replaceAll(".","-").replaceAll("/","-"); const dt=new Date(s); return isNaN(dt)?null:dt; };
  const fmtDate=(d)=>!d?"":d.toISOString().slice(0,10);
  const norm=(s)=>(s??"").toString().trim();

  // 부분 일치 검색을 위한 행 전체 텍스트 생성
  const buildSearchText = (obj) =>
    [obj.vendor,obj.category,obj.project,obj.type,obj.unit,obj.grade,obj.note,obj.unitPrice,obj.qty,fmtDate(obj.poDate)]
      .join(" ").toLowerCase();

  function detectHeaders(headerRow){
    const h={}; const row=headerRow.map(h=>norm(h).toLowerCase());
    for(const [key,aliases] of Object.entries(HEADER_MAP)){
      let i=-1; for(const a of aliases){ const idx=row.indexOf(norm(a).toLowerCase()); if(idx!==-1){i=idx;break;} }
      h[key]=i;
    }
    return h;
  }

  function loadSheet(wb){
    const name=wb.SheetNames.find(n=>PREFERRED_SHEET_NAMES.includes(n))||wb.SheetNames[0];
    const sheet=wb.Sheets[name];
    const rows=XLSX.utils.sheet_to_json(sheet,{header:1,defval:""});
    if(!rows.length) throw new Error("시트가 비어 있습니다.");
    const map=detectHeaders(rows[0]);

    rawRows = rows.slice(1).map(r=>{
      const obj={
        vendor:norm(r[map.vendor]), category:norm(r[map.category]), poDate:parseDate(r[map.poDate]),
        project:norm(r[map.project]), type:norm(r[map.type]),
        unitPrice:r[map.unitPrice]===""?"":Number(String(r[map.unitPrice]).replace(/[^\d.-]/g,"")),
        unit:norm(r[map.unit]), grade:norm(r[map.grade]),
        qty:r[map.qty]===""?"":Number(String(r[map.qty]).replace(/[^\d.-]/g,"")),
        note:norm(r[map.note])
      };
      obj._search = buildSearchText(obj); // ▼ 부분 일치용 텍스트
      return obj;
    }).filter(r=>Object.values(r).some(v=>v!==""));

    sortAsc=false;
    populateVendorOptions();
    applyFiltersAndRender();
    countTotal.textContent=rawRows.length.toLocaleString('ko-KR');
  }

  function populateVendorOptions(){
    const vendors=[...new Set(rawRows.map(r=>r.vendor).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'ko'));
    const prev=norm(vendorInput.value);
    vendorSet=new Set(vendors);
    vendorList.innerHTML = vendors.map(v=>`<option value="${escapeHtml(v)}"></option>`).join("");
    if(prev && vendorSet.has(prev)) vendorInput.value=prev; else vendorInput.value="";
  }

  function sortRows(){
    viewRows.sort((a,b)=>{ const ad=a.poDate?.getTime() ?? -Infinity; const bd=b.poDate?.getTime() ?? -Infinity; return sortAsc?ad-bd:bd-ad; });
  }

  function activeFilterChips(){
    const chips=[];
    if(vendorInput.value) chips.push(`<span class="chip">구매처명: ${escapeHtml(vendorInput.value)}</span>`);
    if(globalSearch.value) chips.push(`<span class="chip">검색(부분 일치): “${escapeHtml(globalSearch.value)}”</span>`);
    $("#activeFilters").innerHTML=chips.join("");
  }

  function applyFiltersAndRender(){
    const vFilter=norm(vendorInput.value);
    const q = norm(globalSearch.value).toLowerCase().trim();
    const qTokens = q ? q.split(/\s+/) : [];

    viewRows = rawRows.filter(r=>{
      const vendorOk = !vFilter || r.vendor===vFilter;
      let qOk = true;
      if(qTokens.length){
        // ▼ “단어의 일부라도 포함되면” 매칭
        qOk = qTokens.every(t => r._search.includes(t));
      }
      return vendorOk && qOk;
    });

    sortRows();
    renderTable();
    countShown.textContent=viewRows.length.toLocaleString('ko-KR');
    activeFilterChips();
    updateVendorInfo();
  }

  function renderTable(){
    const html=viewRows.map(r=>`
      <tr>
        <td class="sticky-col col-0">${fmtDate(r.poDate)}</td>
        <td class="sticky-col col-1">${escapeHtml(r.project)}</td>
        <td>${escapeHtml(r.type)}</td>
        <td class="right">${fmtKRW(r.unitPrice)}</td>
        <td>${escapeHtml(r.unit)}</td>
        <td>${escapeHtml(r.grade)}</td>
        <td class="right">${fmtQty(r.qty)}</td>
        <td>${escapeHtml(r.note)}</td>
        <td class="hidden">${escapeHtml(r.vendor)}</td>
        <td class="hidden">${escapeHtml(r.category)}</td>
      </tr>`).join("");
    tbody.innerHTML = html || `<tr><td colspan="10" style="text-align:center;color:var(--muted);padding:22px;">조건에 맞는 데이터가 없습니다.</td></tr>`;
  }

  function updateVendorInfo(){
    const v=norm(vendorInput.value);
    if(!v){ vendorInfo.textContent=''; vendorInfo.classList.add('muted'); return; }
    const rows=rawRows.filter(r=>r.vendor===v);
    if(!rows.length){ vendorInfo.textContent='일치하는 구매처 데이터가 없습니다.'; vendorInfo.classList.add('muted'); return; }
    const dates=rows.map(r=>r.poDate).filter(Boolean).map(d=>d.getTime());
    const minD=dates.length?new Date(Math.min(...dates)):null;
    const maxD=dates.length?new Date(Math.max(...dates)):null;
    const sumUnitPrice=rows.reduce((a,r)=>a+(Number.isFinite(r.unitPrice)?r.unitPrice:0),0);
    vendorInfo.classList.remove('muted');
    vendorInfo.innerHTML=`<span class="pill">선택한 업체: ${escapeHtml(v)}</span>
      <span class="pill">건수: ${rows.length.toLocaleString('ko-KR')}건</span>
      <span class="pill">최초 PO: ${fmtDate(minD)||'-'}</span>
      <span class="pill">최신 PO: ${fmtDate(maxD)||'-'}</span>
      <span class="pill">단가 합계: ${fmtKRW(sumUnitPrice)}</span>`;
  }

  function escapeHtml(s){return String(s??"").replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]||c));}

  // 유효성(목록 밖 수기 입력 방지): 목록에 없으면 비움
  function validateVendor(){
    const v=norm(vendorInput.value);
    if(!v) return true;
    if(vendorSet.has(v)) return true;
    vendorInput.value="";
    vendorInfo.classList.remove('muted');
    vendorInfo.textContent="목록에 없는 값입니다. 드롭다운에서 선택해주세요.";
    return false;
  }

  // 이벤트
  $("#file").addEventListener('change', async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const buf=await f.arrayBuffer(); const wb=XLSX.read(buf); loadSheet(wb);
  });
  vendorInput.addEventListener('input', ()=>{ applyFiltersAndRender(); });
  vendorInput.addEventListener('change', ()=>{ if(validateVendor()) applyFiltersAndRender(); });
  vendorInput.addEventListener('blur',   ()=>{ if(validateVendor()) applyFiltersAndRender(); });
  globalSearch.addEventListener('input', applyFiltersAndRender);
  $("#resetBtn").addEventListener('click', ()=>{ vendorInput.value=""; globalSearch.value=""; applyFiltersAndRender(); });
  $("#reloadBtn").addEventListener('click', ()=>{ loadDefault(); });
  sortBtn.addEventListener('click', ()=>{ sortAsc=!sortAsc; sortBtn.textContent=`PO생성일 ${sortAsc?'⬆':'⬇'}`; sortRows(); renderTable(); });

  function adjustTheadTop(){ const h=headerEl.getBoundingClientRect().height; document.documentElement.style.setProperty('--thead-top',`${Math.ceil(h)+2}px`); }
  window.addEventListener('resize', adjustTheadTop);
  window.addEventListener('load', adjustTheadTop);

  async function loadDefault(){
    try{
      const res=await fetch(DEFAULT_URL(),{cache:'no-store'});
      if(!res.ok) throw new Error('기본 파일(data.xlsx)을 찾을 수 없습니다. 상단에서 파일을 선택하세요.');
      const buf=await res.arrayBuffer(); const wb=XLSX.read(buf); loadSheet(wb);
    }catch(e){
      console.warn(e); rawRows=[]; viewRows=[];
      tbody.innerHTML=`<tr><td colspan="10" style="text-align:center;color:var(--muted);padding:22px;">기본 파일을 찾을 수 없습니다. 상단에서 Excel 파일을 선택하세요.</td></tr>`;
      countShown.textContent='0'; countTotal.textContent='0'; vendorInfo.textContent='';
    }finally{ adjustTheadTop(); }
  }
  loadDefault();
</script>
</body>
</html>
